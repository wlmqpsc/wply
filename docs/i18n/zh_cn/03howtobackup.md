# 如何备份

您需要理解，您使用本项目时造成的数据、经济损失，本项目概不负责。

## Peek

我编写了一个bash脚本，用来处理备份。在使用这个脚本前你需要设置一些信息。该脚本不仅可以用来备份站点，事实上它也可以备份所有的docker卷，和数据库的所有内容。

脚本文件位于 `./scripts/backup.sh`

## 使用方法

脚本运行时需要 root 权限，因此需要使用 `sudo ./scripts/backup.sh`

### 参数

使用文本编辑器打开该脚本后，您可以看到一个名字叫`set_env()`您需要修改下列信息

1. `mariadb_root_password` 在 `=` 后面输入您的 MariaDB 数据库的 root 密码，请**不要**在密码和等号间加空格。  
注：后序会优化这个设置方式

下面这些参数的修改为可选项，您可根据需求，修改下面的信息

1. `volumes` 要备份的docker卷的名字，您可以使用此脚本来备份其它 docker 卷，请不要在该数组中添加不存在的卷，否则脚本将无法运行。
2. `max_backups` 为最大备份数量，指的是您需要在服务器上保留多少个备份，如果备份目录下的文件夹多余这个数量，运行脚本时多余的备份将被**删除**。
3. `timestamp` 为时间戳，备份文件夹将会以时间戳的方式命名，例如 `1970_01_01`  
如果您需要详细的时间参数（对应一天内生成数个备份的场景），只需要取消下方的注释。
4. `backup_root` 为备份文件夹的根路径，如非必要，无需修改。
5. `backup_dir` 运行时生成的备份文件夹的位置，如非必要，无需修改。
6. `log_dir` 日志文件夹，如非必要，无需修改。
7. `log_file` 运行时日志存储的位置，如非必要，无需修改。

### 设置自动运行

首先检查你的系统时区，然后使用 `sudo crontab -e` 设置自动备份，您可以参照下面的例子设置备份

```bash
0 4 * * * /path/to/backup.sh # 每日 04:00 AM 执行
0 4 * * 1 /path/to/backup.sh # 每周一 04:00 AM 执行
0 4 1 * * /path/to/backup.sh # 每月1日 04:00 AM 执行
```

### 备份运行流程

1. 停止所有使用要备份的卷的容器
2. 创建容器，备份卷
3. 备份数据库
4. 启动所有容器
5. 生成 sha256 校验和
6. 检测备份路径下的文件夹数量是否多于 `max_backups`  
   如果多余则删去所有旧的文件夹，直至数量小于 `max_backups`

默认情况下，备份将会生成在项目路径下的 `./site_backup` 目录，您可以在 `./log` 目录下查看日志。目前，日志不会被自动清理。

### 关于数据库备份

本项目使用了 Mariabackup 进行物理备份，而非逻辑备份，您可以在[这里](https://mariadb.com/kb/en/backup-and-restore-overview/)找到它们的区别。

物理备份会备份数据库的全部内容，在恢复时也需要删除目标数据库的所有内容，包含数据库配置信息等。

### 完善脚本

脚本中有一个 `sync_with_rsync()` 函数，您可以取消它的注释，完善这个脚本，用于将备份自动同步到其它服务器。

## 注意事项

- 请不要在备份路径下创建任何文件或文件夹，可能导致意外错误！
- 请不要模仿脚本在备份路径下储存其它文件，符合脚本命名规范的文件夹将被删除！
- 脚本运行时可能会删除旧的备份！
